!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@tanstack/query-core"),require("jotai")):"function"==typeof define&&define.amd?define(["exports","@tanstack/query-core","jotai"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jotaiQuery={},e.queryCore,e.jotai)}(this,(function(e,t,n){"use strict";var r=n.atom(new t.QueryClient);e.atomWithInfiniteQuery=function(e,u){void 0===u&&(u=function(e){return e(r)});var o=n.atom((function(r){var o=u(r),i="function"==typeof e?e(r):e,s=o.defaultQueryOptions(i),a=new t.InfiniteQueryObserver(o,s),c=a.getCurrentResult(),l=null,f=n.atom(void 0===c.data&&!1!==i.enabled?new Promise((function(e){l=e})):c),d=function(){throw new Error("setting result without mount")},b={isMounted:!1,unsubscribe:null},v=function(e){e.isFetching||!e.isError&&void 0===e.data||e.isError&&t.isCancelledError(e.error)||(l?(setTimeout((function(){b.isMounted||(null==b.unsubscribe||b.unsubscribe(),b.unsubscribe=null)}),1e3),l(e),l=null):d(e))};return!1!==i.enabled&&(b.unsubscribe=a.subscribe(v)),f.onMount=function(e){return d=e,b.isMounted=!0,!1===i.enabled||b.unsubscribe||(b.unsubscribe=a.subscribe(v),v(a.getCurrentResult())),function(){return null==b.unsubscribe?void 0:b.unsubscribe()}},{options:i,resultAtom:f,observer:a,state:b}}),(function(e,t,n){var r=e(o),u=r.options,i=r.resultAtom,s=r.observer,a=r.state;if(!1!==u.enabled)switch(n.type){case"refetch":return t(i,new Promise((function(){}))),a.isMounted||(null==a.unsubscribe||a.unsubscribe(),a.unsubscribe=null),void s.refetch(n.payload).then((function(e){t(i,e)}));case"fetchPreviousPage":return void s.fetchPreviousPage();case"fetchNextPage":return void s.fetchNextPage()}}));return n.atom((function(e){var t=e(o),n=e(t.resultAtom);if(n.isError)throw n.error;return n.data}),(function(e,t,n){return t(o,n)}))},e.atomWithQuery=function(e,u){void 0===u&&(u=function(e){return e(r)});var o=new WeakMap,i=n.atom((function(r){var i=u(r),s="function"==typeof e?e(r):e,a=new t.QueryObserver(i,s),c=a.getCurrentResult();void 0===c.data&&s.keepPreviousData&&o.has(i)&&(c.data=o.get(i));var l,f=null,d=function(){return new Promise((function(e){f=e}))},b=n.atom(void 0===c.data&&!1!==s.enabled?d():c),v=null,m=function(e){if(!e.isFetching&&(e.isError||void 0!==e.data)){if(!f&&!v)throw new Error("setting result without mount");f&&(f(e),f=null),v&&v(e),void 0!==e.data&&o.set(i,e.data)}},h=null,y=function(){!v&&h&&(clearTimeout(l),h(),h=null),!1!==s.enabled&&(v?a.refetch({cancelRefetch:!0}).then(v):h=a.subscribe(m)),v||(l=setTimeout((function(){h&&(h(),h=null)}),1e3))};return y(),b.onMount=function(e){return v=e,h?clearTimeout(l):y(),function(){v=null,h&&h()}},{resultAtom:b,makePending:d,startQuery:y}}));return n.atom((function(e){var t=e(i),n=e(t.resultAtom);if(n.isError)throw n.error;return n.data}),(function(e,t,n){var r=e(i),u=r.resultAtom,o=r.makePending,s=r.startQuery;if("refetch"===n.type)t(u,o()),s()}))},e.queryClientAtom=r,Object.defineProperty(e,"__esModule",{value:!0})}));
